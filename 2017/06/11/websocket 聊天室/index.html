<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>websocket 聊天室 | jacksun&#39;s blog</title>
  <meta name="description" content="金股棒架构分析与发布在本文中，我们将一步步编写出来聊天室PC端和APP端重新做一次梳理，以及进行一些优化，让整个项目更容易理解和扩展。其次我们还会介绍一些前端流行的工具，帮助我们构建项目，便于发布。 项目结构目前PC端和APP端项目的架构大致相似，如下图：  箭头代表了读取数据的流向，服务端和客户端基本上都分为三层：  服务端：在MongoDB和mongoose之上，我们添加了一层模型的contr">
<meta name="keywords" content="Node.js,Socket.io">
<meta property="og:type" content="article">
<meta property="og:title" content="websocket 聊天室">
<meta property="og:url" content="https://sensitivemix.github.io/2017/06/11/websocket 聊天室/index.html">
<meta property="og:site_name" content="孙祁的博客">
<meta property="og:description" content="金股棒架构分析与发布在本文中，我们将一步步编写出来聊天室PC端和APP端重新做一次梳理，以及进行一些优化，让整个项目更容易理解和扩展。其次我们还会介绍一些前端流行的工具，帮助我们构建项目，便于发布。 项目结构目前PC端和APP端项目的架构大致相似，如下图：  箭头代表了读取数据的流向，服务端和客户端基本上都分为三层：  服务端：在MongoDB和mongoose之上，我们添加了一层模型的contr">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/island205/technode-tutorial/blob/Angular2/archive/examples/chapter04/images/TechNodestructure.png?raw=true">
<meta property="og:image" content="https://github.com/island205/technode-tutorial/raw/Angular2/archive/examples/chapter04/images/TechNodestructurenew.png">
<meta property="og:updated_time" content="2019-04-14T02:29:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="websocket 聊天室">
<meta name="twitter:description" content="金股棒架构分析与发布在本文中，我们将一步步编写出来聊天室PC端和APP端重新做一次梳理，以及进行一些优化，让整个项目更容易理解和扩展。其次我们还会介绍一些前端流行的工具，帮助我们构建项目，便于发布。 项目结构目前PC端和APP端项目的架构大致相似，如下图：  箭头代表了读取数据的流向，服务端和客户端基本上都分为三层：  服务端：在MongoDB和mongoose之上，我们添加了一层模型的contr">
<meta name="twitter:image" content="https://github.com/island205/technode-tutorial/blob/Angular2/archive/examples/chapter04/images/TechNodestructure.png?raw=true">
  <!-- Canonical links -->
  <link rel="canonical" href="https://sensitivemix.github.io/2017/06/11/websocket 聊天室/index.html">
  
    <link rel="alternate" href="/atom.xml" title="孙祁的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/SensitiveMix" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Jack Sun</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Full Stack Developer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Nanjing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索">
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech="">
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope="" itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/SensitiveMix" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope="" itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/前沿技术/">前沿技术</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学习资料/">学习资料</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发/">开发</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发工具/">开发工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/总结/">总结</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BestPractice/">BestPractice</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blockchain/">Blockchain</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-Pointer/">C Pointer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CI/">CI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cluster/">Cluster</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CodeCoverage/">CodeCoverage</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Database/">Database</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DesignPattern/">DesignPattern</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Frontend/">Frontend</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/InfluxDB/">InfluxDB</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jquery/">Jquery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Login/">Login</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MockService/">MockService</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/">Node.js</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Socket-io/">Socket.io</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SqlServer/">SqlServer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swagger-Doc/">Swagger Doc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tutorial/">Tutorial</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/BestPractice/" style="font-size: 13px;">BestPractice</a> <a href="/tags/Blockchain/" style="font-size: 13.25px;">Blockchain</a> <a href="/tags/C-Pointer/" style="font-size: 13px;">C Pointer</a> <a href="/tags/CI/" style="font-size: 13px;">CI</a> <a href="/tags/Cluster/" style="font-size: 13px;">Cluster</a> <a href="/tags/CodeCoverage/" style="font-size: 13px;">CodeCoverage</a> <a href="/tags/Database/" style="font-size: 13.75px;">Database</a> <a href="/tags/DesignPattern/" style="font-size: 13px;">DesignPattern</a> <a href="/tags/Frontend/" style="font-size: 13.25px;">Frontend</a> <a href="/tags/InfluxDB/" style="font-size: 13.25px;">InfluxDB</a> <a href="/tags/Javascript/" style="font-size: 13.25px;">Javascript</a> <a href="/tags/Jquery/" style="font-size: 13px;">Jquery</a> <a href="/tags/Login/" style="font-size: 13px;">Login</a> <a href="/tags/MockService/" style="font-size: 13px;">MockService</a> <a href="/tags/MongoDB/" style="font-size: 13.25px;">MongoDB</a> <a href="/tags/Node-js/" style="font-size: 14px;">Node.js</a> <a href="/tags/Redis/" style="font-size: 13px;">Redis</a> <a href="/tags/Socket-io/" style="font-size: 13px;">Socket.io</a> <a href="/tags/SqlServer/" style="font-size: 13px;">SqlServer</a> <a href="/tags/Swagger-Doc/" style="font-size: 13px;">Swagger Doc</a> <a href="/tags/Tutorial/" style="font-size: 13.5px;">Tutorial</a> <a href="/tags/http/" style="font-size: 13px;">http</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">9</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2019/04/16/如何书写-Node-DEV-API-文档/" class="title">如何书写 Node DEV API 文档 </a>
              </p>
              <p class="item-date">
                <time datetime="2019-04-16T09:02:20.000Z" itemprop="datePublished">2019-04-16</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/数据库/">数据库</a>
              </p>
              <p class="item-title">
                <a href="/2019/01/07/数据库原理/" class="title">数据库原理</a>
              </p>
              <p class="item-date">
                <time datetime="2019-01-07T14:08:33.000Z" itemprop="datePublished">2019-01-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/数据库/">数据库</a>
              </p>
              <p class="item-title">
                <a href="/2019/01/06/如何设计关系型数据库/" class="title">如何设计关系型数据库</a>
              </p>
              <p class="item-date">
                <time datetime="2019-01-06T07:33:07.000Z" itemprop="datePublished">2019-01-06</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2019/01/01/Redis-的持久和取舍/" class="title">Redis 的持久和取舍</a>
              </p>
              <p class="item-date">
                <time datetime="2019-01-01T13:32:37.000Z" itemprop="datePublished">2019-01-01</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/开发/">开发</a>
              </p>
              <p class="item-title">
                <a href="/2018/12/02/跨域与安全/" class="title">跨域与安全</a>
              </p>
              <p class="item-date">
                <time datetime="2018-12-02T14:03:24.000Z" itemprop="datePublished">2018-12-02</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-websocket 聊天室" class="article article-type-post" itemscope="" itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      websocket 聊天室
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2017/06/11/websocket 聊天室/" class="article-date">
	  <time datetime="2017-06-11T14:25:57.000Z" itemprop="datePublished">2017-06-11</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/开发/">开发</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/Node-js/">Node.js</a>, <a class="article-tag-link" href="/tags/Socket-io/">Socket.io</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2017/06/11/websocket 聊天室/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="金股棒架构分析与发布"><a href="#金股棒架构分析与发布" class="headerlink" title="金股棒架构分析与发布"></a>金股棒架构分析与发布</h2><p>在本文中，我们将一步步编写出来聊天室PC端和APP端重新做一次梳理，以及进行一些优化，让整个项目更容易理解和扩展。其次我们还会介绍一些前端流行的工具，帮助我们构建项目，便于发布。</p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p>目前PC端和APP端项目的架构大致相似，如下图：</p>
<p><img src="https://github.com/island205/technode-tutorial/blob/Angular2/archive/examples/chapter04/images/TechNodestructure.png?raw=true" alt="TechNode Structure"></p>
<p>箭头代表了读取数据的流向，服务端和客户端基本上都分为三层：</p>
<ul>
<li>服务端：在MongoDB和mongoose之上，我们添加了一层模型的controller，这一层直接处理一些业务相关的逻辑；在这之上，我们直接通过http API或者socket.io将所提供的接口暴露出来；这一块的代码全部写在了app.js中；</li>
<li>客户端：针对不同的组件或者页面，我们对应了不同的controller，而这些controller都是通过$http或者socket 服务直接于服务端通信的；各个controller之间共享数据很困难。</li>
</ul>
<p>基于上面的问题，我们做出以下调整：</p>
<ul>
<li>将服务端逻辑从app.js分拆为http和socket两个服务中；</li>
<li>在客户端提供一个统一的数据接口层，向上为controller提供数据服务，向下和服务端通信，同步数据。</li>
</ul>
<p>新的结构应该像下面这样：</p>
<p><img src="https://github.com/island205/technode-tutorial/raw/Angular2/archive/examples/chapter04/images/TechNodestructurenew.png" alt="TechNode Structure"></p>
<h3 id="分拆http和socket服务"><a href="#分拆http和socket服务" class="headerlink" title="分拆http和socket服务"></a>分拆http和socket服务</h3><p>首先简化app.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// ...</span><br><span class="line"></span><br><span class="line">var api = require(&apos;./services/api&apos;)</span><br><span class="line">var socketApi = require(&apos;./services/socketApi&apos;)</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">app.post(&apos;/api/login&apos;, api.login)</span><br><span class="line">app.get(&apos;/api/logout&apos;, api.logout)</span><br><span class="line">app.get(&apos;/api/validate&apos;, api.validate)</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">io.sockets.on(&apos;connection&apos;, function(socket) &#123;</span><br><span class="line"></span><br><span class="line">  socketApi.connect(socket)</span><br><span class="line"></span><br><span class="line">  socket.on(&apos;disconnect&apos;, function() &#123;</span><br><span class="line">    socketApi.disconnect(socket)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  socket.on(&apos;technode&apos;, function(request) &#123;</span><br><span class="line">    socketApi[request.action](request.data, socket, io)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>
<p>我们把http和socket的回调分别放到api.js和socketApi.js中，在socket通信方面做了简化，使用<code>technode</code>作为统一的事件名，而需要调用的接口名，则由请求数据中的<code>action</code>来决定。每个socket请求都会变成下面这样：</p>
<p>客户端的请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">socket.emit(&apos;technode&apos;, &#123;</span><br><span class="line">  action: &apos;getRoom&apos;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>下面是服务端的返回：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">socket.emit(&apos;technode&apos;, &#123;</span><br><span class="line">  &quot;action&quot;: &quot;getRoom&quot;,</span><br><span class="line">  &quot;data&quot;: [&#123;</span><br><span class="line">    &quot;name&quot;: &quot;Socket.IO&quot;,</span><br><span class="line">    &quot;_id&quot;: &quot;52b0e5dd0a5e66fa26000001&quot;,</span><br><span class="line">    &quot;__v&quot;: 0,</span><br><span class="line">    &quot;createAt&quot;: &quot;2013-12-18T00:01:33.528Z&quot;,</span><br><span class="line">    &quot;users&quot;: [],</span><br><span class="line">    &quot;messages&quot;: []</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>客户端则根据action，进行不同的处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">socket.on(&apos;technode&apos;, function (data) &#123;</span><br><span class="line">  switch (data.action) &#123;</span><br><span class="line">      // ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>而本身api.js和socketApi.js内的处理，与第三章的基本无异，不再细说。</p>
<h3 id="客户端缓存"><a href="#客户端缓存" class="headerlink" title="客户端缓存"></a>客户端缓存</h3><p>为什么需要客户端缓存？有两点原因：</p>
<ol>
<li>在第三章的实现中，在房间列表和房间切换时，controller都会通过socket从服务端重新获取房间列表或房间；</li>
<li>在第三章的实现中，我们无法在controller之间共享数据，比如在LoginCtrl中，用户登录后，我们需要更新$rootScope的用户信息，采用了scope事件机制来实现。</li>
</ol>
<p>我们需要一个缓存数据和共享数据的组件，这个组件将服务端请求来的数据缓存下来，避免重复的从服务端请求相同的数据，其次是对所有的controller提供接口，让controller间可以共享（读取、修改）同一份数据。</p>
<p>我们把这个组件命名为server，与服务端通信完全通过这个组件，数据缓存到这个组件之中，controller直接与它通信，不必关心真正的服务器是什么样的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&apos;techNodeApp&apos;).factory(&apos;server&apos;, [&apos;$cacheFactory&apos;, &apos;$q&apos;, &apos;$http&apos;, &apos;socket&apos;, function($cacheFactory, $q, $http, socket) &#123;</span><br><span class="line">  var cache = window.cache = $cacheFactory(&apos;technode&apos;)</span><br><span class="line">  socket.on(&apos;technode&apos;, function(data) &#123;</span><br><span class="line">    switch (data.action) &#123;</span><br><span class="line">      case &apos;getRoom&apos;:</span><br><span class="line">        if (data._roomId) &#123;</span><br><span class="line">          angular.extend(cache.get(data._roomId), data.data)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          data.data.forEach(function (room) &#123;</span><br><span class="line">            cache.get(&apos;rooms&apos;).push(room)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        break</span><br><span class="line">      // case something else</span><br><span class="line">      // handle for socket events</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  socket.on(&apos;err&apos;, function (data) &#123;</span><br><span class="line">    // handle server err</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return &#123;</span><br><span class="line">    validate: function() &#123;</span><br><span class="line">      var deferred = $q.defer()</span><br><span class="line">      $http(&#123;</span><br><span class="line">        url: &apos;/api/validate&apos;,</span><br><span class="line">        method: &apos;GET&apos;</span><br><span class="line">      &#125;).success(function(user) &#123;</span><br><span class="line">        angular.extend(cache.get(&apos;user&apos;), user)</span><br><span class="line">        deferred.resolve()</span><br><span class="line">      &#125;).error(function(data) &#123;</span><br><span class="line">        deferred.reject()</span><br><span class="line">      &#125;)</span><br><span class="line">      return deferred.promise</span><br><span class="line">    &#125;</span><br><span class="line">    // more API</span><br><span class="line">  &#125;</span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>
<p>在server中，我们使用了两个Angular提供的组件，<code>$q</code>和<code>$cacheFactory</code>。</p>
<h4 id="q"><a href="#q" class="headerlink" title="$q"></a>$q</h4><p>$q是Angular对JavaScript异步编程模式Promise的实现，参考了<a href="https://github.com/kriskowal/q" target="_blank" rel="noopener">https://github.com/kriskowal/q</a> 。在TechNode对它的用法相对比较简单，仅仅是将Ajax请求隐藏起来。以server.validate为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">validate: function() &#123;</span><br><span class="line">  var deferred = $q.defer()</span><br><span class="line">  $http(&#123;</span><br><span class="line">    url: &apos;/api/validate&apos;,</span><br><span class="line">    method: &apos;GET&apos;</span><br><span class="line">  &#125;).success(function(user) &#123;</span><br><span class="line">    angular.extend(cache.get(&apos;user&apos;), user)</span><br><span class="line">    deferred.resolve()</span><br><span class="line">  &#125;).error(function(data) &#123;</span><br><span class="line">    deferred.reject()</span><br><span class="line">  &#125;)</span><br><span class="line">  return deferred.promise</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$q.defer()</code>获取一个differed（推迟）对象，然后<code>return deferred.promise</code>先返回promise（承诺），在服务器端成功返回后，resolve（兑现）承诺，或者遇到问题，reject（拒绝）兑现。</p>
<p>在technode.js中我们可以这样使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server.validate().then(function() &#123;</span><br><span class="line">  if ($location.path() === &apos;/login&apos;) &#123;</span><br><span class="line">    $location.path(&apos;/rooms&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, function() &#123;</span><br><span class="line">  $location.path(&apos;/login&apos;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>server.validate()</code>获取promise（承诺）对象，then(resolvedCallback, rejectCallack)（然后）根据承诺的兑现情况进行不同的处理。</p>
<p>换句话说，technode.js中的<code>techNodeApp</code>问server，用户是不是登录了，server必须调用服务端接口进行验证，因此server给<code>techNodeApp</code>许诺，<code>techNodeApp</code>则只需要针对许诺是否兑现进行处理就好了。</p>
<p>所有与http请求相关的接口，我们都做了相似的处理。</p>
<h4 id="cacheFactory"><a href="#cacheFactory" class="headerlink" title="$cacheFactory"></a>$cacheFactory</h4><p>$cacheFactory是Angular提供的缓存组件，该组件直接将数据存放在内存中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var cache = window.cache = $cacheFactory(&apos;technode&apos;)</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">cache.put(&apos;rooms&apos;, [])</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">cache.get(&apos;rooms&apos;) &amp;&amp; cache.get(&apos;rooms&apos;).forEach(function(room) &#123;</span><br><span class="line">  if (room._id === _roomId) &#123;</span><br><span class="line">    room.users = room.users.filter(function(user) &#123;</span><br><span class="line">      return user._id !== _userId</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>直接调用$cacheFactory，传入cacheId，Angular就为我构造出一块缓存区域，我们就可以通过get、put等等方法来存储或者获取缓存数据了。</p>
<p>$cacheFactory还提供了一种TechNode中未使用的特性，即这块缓存可以是LRU的，什么是LRU？即这块缓存是有大小的（避免缓存开销过大，影响网易性能），并且这块缓存使用LRU算法来淘汰长时间未使用的数据。</p>
<h3 id="controller与server"><a href="#controller与server" class="headerlink" title="controller与server"></a>controller与server</h3><p>有了server，我们来看看controller有什么变化？这是原来的RoomCtrl的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&apos;techNodeApp&apos;).controller(&apos;RoomCtrl&apos;, function($scope, $routeParams, $scope, socket) &#123;</span><br><span class="line">  socket.on(&apos;rooms.read&apos; + $routeParams._roomId, function(room) &#123;</span><br><span class="line">    $scope.room = room</span><br><span class="line">  &#125;)</span><br><span class="line">  socket.emit(&apos;rooms.read&apos;, &#123;</span><br><span class="line">    _roomId: $routeParams._roomId</span><br><span class="line">  &#125;)</span><br><span class="line">  socket.on(&apos;messages.add&apos;, function(message) &#123;</span><br><span class="line">    $scope.room.messages.push(message)</span><br><span class="line">  &#125;)</span><br><span class="line">  // ...</span><br><span class="line">  socket.on(&apos;users.join&apos;, function (join) &#123;</span><br><span class="line">    $scope.room.users.push(join.user)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  socket.on(&apos;users.leave&apos;, function(leave) &#123;</span><br><span class="line">    _userId = leave.user._id</span><br><span class="line">    $scope.room.users = $scope.room.users.filter(function(user) &#123;</span><br><span class="line">      return user._id != _userId</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这是基于server组件修改后的RoomCtrl：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&apos;techNodeApp&apos;).controller(&apos;RoomCtrl&apos;, [&apos;$scope&apos;, &apos;$routeParams&apos;, &apos;$scope&apos;, &apos;server&apos;, function($scope, $routeParams, $scope, server) &#123;</span><br><span class="line"></span><br><span class="line">  $scope.room = server.getRoom($routeParams._roomId)</span><br><span class="line"></span><br><span class="line">  // ...</span><br><span class="line">&#125;])</span><br></pre></td></tr></table></figure>
<p>我们可以发现如下的变化：</p>
<ul>
<li>RoomCtrl不再直接与服务端通信读取当前的房间信息；</li>
<li>无需监听用户进入、离开或者新消息的事件。</li>
</ul>
<p>RoomCtrl只需调用server.getRoom，传入房间的id即可。那房间信息不是需要到服务端读取么？这是怎么实现的？</p>
<p>这完全得益于Angular数据绑定特性，即数据变化，视图也会跟着变化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">getRoom: function(_roomId) &#123;</span><br><span class="line">  if (!cache.get(_roomId)) &#123;</span><br><span class="line">    cache.put(_roomId, &#123;</span><br><span class="line">      users: [],</span><br><span class="line">      messages: []</span><br><span class="line">    &#125;)</span><br><span class="line">    socket.emit(&apos;technode&apos;, &#123;</span><br><span class="line">      action: &apos;getRoom&apos;,</span><br><span class="line">      data: &#123;</span><br><span class="line">        _roomId: _roomId</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  return cache.get(_roomId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的处理方式与<code>promise</code>有异曲同工之妙。<code>getRoom</code>方法，如果在缓存中没有找到房间的数据，就先新建一个房间对象，不过里面的数据都是空的（此时，RoomCtrl渲染出来的是一个空的房间视图），然后通过socket向服务端请求房间数据；如果找到就直接返回从缓存中获取的房间数据，RoomCtrl就可以渲染出来一个正常的房间视图。</p>
<p>而在服务端返回房间信息后，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">case &apos;getRoom&apos;:</span><br><span class="line">  if (data._roomId) &#123;</span><br><span class="line">    angular.extend(cache.get(data._roomId), data.data)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    data.data.forEach(function (room) &#123;</span><br><span class="line">      cache.get(&apos;rooms&apos;).push(room)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们使用服务端的数据填充到空房间即可，Angular即根据数据的变化，渲染出新的房间视图。</p>
<blockquote>
<p>我们必须保证更新的房间对象必须是视图绑定的对象，因此我们一开始就返回一个房间对象，后面只是修改这个对象的属性。</p>
</blockquote>
<p>同理，RoomCtrl也无需出来用户进入或者离开房间，有新消息这类事件，因为server组件会自动更新对应的数据，RoomCtrl只需要按照数据渲染即可。</p>
<p>好了，我们利用客户端缓存和Angular数据绑定特性，大大简化了TechNode控制器层。到此，我们的开发之旅已经接近尾声，接下来，我们将学习如何将前端程序打包，发布！</p>
<h3 id="使用Grunt打包TechNode"><a href="#使用Grunt打包TechNode" class="headerlink" title="使用Grunt打包TechNode"></a>使用Grunt打包TechNode</h3><p>开发时，为了解耦和便于维护，我们把代码拆成单独的文件，JavaScript代码、CSS代码和HTML都是单独的。在生产环境中，为了提高性能，我们需要把这些分开的文件合并到一起。如果你的网站使用CDN的化，我们还需要给每个版本的文件，添加上唯一的标识，便于维护CDN的缓存。</p>
<p>Grunt是目前JavaScript最流行的项目自动化构建工具。Grunt官方提供了很多插件，也有大量的第三方插件。我们可以轻松地使用Grunt检查、压缩合并代码，甚至发布应用程序。我们将基于grunt-usemin等几个流行的Grunt插件来构建TechNode项目。</p>
<p>首先我们需要做一些准备，安装Grunt命令行和运行时，在TechNode根目录新建Gruntfile.js。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g grunt-cli &amp;&amp; npm install grunt --save-dev &amp;&amp; touch Gruntfile.js</span><br></pre></td></tr></table></figure>
<p>为了使用grunt-usemin来压缩我们的代码，我们需要在index.html添加一些特殊的注释来来帮助grunt-usemin找到需要合并的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- build:css /css/technode.css --&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/components/bootstrap/dist/css/bootstrap.min.css&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/styles/style.css&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/styles/login.css&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/styles/rooms.css&quot;&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/styles/room.css&quot;&gt;</span><br><span class="line">&lt;!-- endbuild --&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;!-- build:js /script/technode.js --&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/components/jquery/jquery.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/components/bootstrap/dist/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/components/angular/angular.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/components/angular-route/angular-route.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/components/moment/moment.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/components/angular-moment/angular-moment.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/components/moment/lang/zh-cn.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/technode.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/services/socket.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/services/server.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/router.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/directives/auto-scroll-to-bottom.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/directives/ctrl-enter-break-line.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/controllers/login.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/controllers/rooms.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/controllers/room.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/controllers/message-creator.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;!-- endbuild --&gt;</span><br></pre></td></tr></table></figure>
<p>我们分别在css和javascript的引用周围加上了注释，<code>&lt;!-- build:css /css/technode.css --&gt;</code>标明我们需要把下面这些css都合并到technode.css这个文件中，javascript全都合并到technode.js中。</p>
<blockquote>
<p>注意，socket.io.js这个文件并没有包含进来，因为它是socket.io自己输出的，并没有在我们的自己的源码中。当然，我们甚至可以把这个文件保存到源码中，自己引用也是可以的。</p>
</blockquote>
<p>首先使用grunt-contrib-copy将不需要打包压缩的文件拷贝到build目录中，修改Gruntfile.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function (grunt) &#123;</span><br><span class="line">  grunt.initConfig(&#123;</span><br><span class="line">    copy: &#123;</span><br><span class="line">      main: &#123;</span><br><span class="line">        files: [</span><br><span class="line">          &#123;expand: true, cwd: &apos;static/components/bootstrap/dist/fonts/&apos;, src: [&apos;**&apos;], dest: &apos;build/fonts&apos;&#125;,</span><br><span class="line">          &#123;&apos;build/index.html&apos;: &apos;static/index.html&apos;&#125;,</span><br><span class="line">          &#123;&apos;build/favicon.ico&apos;: &apos;static/favicon.ico&apos;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-contrib-copy&apos;)</span><br><span class="line"></span><br><span class="line">  grunt.registerTask(&apos;default&apos;, [</span><br><span class="line">    &apos;copy&apos;</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>grunt-usemin为我们提供了一个useminPrepare的task，这个task就是基于我们在index.html文件中的配置，自动生成合并和压缩代码的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function (grunt) &#123;</span><br><span class="line">  grunt.initConfig(&#123;</span><br><span class="line">    copy: &#123;</span><br><span class="line">      main: &#123;</span><br><span class="line">        files: [</span><br><span class="line">          &#123;expand: true, cwd: &apos;static/components/bootstrap/dist/fonts/&apos;, src: [&apos;**&apos;], dest: &apos;build/fonts&apos;&#125;,</span><br><span class="line">          &#123;&apos;build/index.html&apos;: &apos;static/index.html&apos;&#125;,</span><br><span class="line">          &#123;&apos;build/favicon.ico&apos;: &apos;static/favicon.ico&apos;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    useminPrepare: &#123;</span><br><span class="line">      html: &apos;static/index.html&apos;,</span><br><span class="line">      options: &#123;</span><br><span class="line">        dest: &apos;build&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-usemin&apos;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-contrib-copy&apos;)</span><br><span class="line"></span><br><span class="line">  grunt.registerTask(&apos;default&apos;, [</span><br><span class="line">    &apos;copy&apos;,</span><br><span class="line">    &apos;useminPrepare&apos;</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>npm install grunt-usemin --save-dev</code>，运行<code>grunt</code>试试看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Running &quot;useminPrepare:html&quot; (useminPrepare) task</span><br><span class="line">Going through static/index.html to update the config</span><br><span class="line">Looking for build script HTML comment blocks</span><br><span class="line"></span><br><span class="line">Configuration is now:</span><br><span class="line"></span><br><span class="line">  concat:</span><br><span class="line">  &#123; generated:</span><br><span class="line">   &#123; files:</span><br><span class="line">      [ &#123; dest: &apos;.tmp/concat/css/technode.css&apos;,</span><br><span class="line">          src:</span><br><span class="line">           [ &apos;static/components/bootstrap/dist/css/bootstrap.min.css&apos;,</span><br><span class="line">             &apos;static/styles/style.css&apos;,</span><br><span class="line">             &apos;static/styles/login.css&apos;,</span><br><span class="line">             &apos;static/styles/rooms.css&apos;,</span><br><span class="line">             &apos;static/styles/room.css&apos; ] &#125;,</span><br><span class="line">        &#123; dest: &apos;.tmp/concat/script/technode.js&apos;,</span><br><span class="line">          src:</span><br><span class="line">           [ &apos;static/components/jquery/jquery.js&apos;,</span><br><span class="line">             &apos;static/components/bootstrap/dist/js/bootstrap.min.js&apos;,</span><br><span class="line">             &apos;static/components/angular/angular.js&apos;,</span><br><span class="line">             &apos;static/components/angular-route/angular-route.js&apos;,</span><br><span class="line">             &apos;static/components/moment/moment.js&apos;,</span><br><span class="line">             &apos;static/components/angular-moment/angular-moment.js&apos;,</span><br><span class="line">             &apos;static/components/moment/lang/zh-cn.js&apos;,</span><br><span class="line">             &apos;static/technode.js&apos;,</span><br><span class="line">             &apos;static/services/socket.js&apos;,</span><br><span class="line">             &apos;static/services/server.js&apos;,</span><br><span class="line">             &apos;static/router.js&apos;,</span><br><span class="line">             &apos;static/directives/auto-scroll-to-bottom.js&apos;,</span><br><span class="line">             &apos;static/directives/ctrl-enter-break-line.js&apos;,</span><br><span class="line">             &apos;static/controllers/login.js&apos;,</span><br><span class="line">             &apos;static/controllers/rooms.js&apos;,</span><br><span class="line">             &apos;static/controllers/room.js&apos;,</span><br><span class="line">             &apos;static/controllers/message-creator.js&apos; ] &#125; ] &#125; &#125;</span><br><span class="line"></span><br><span class="line">  uglify:</span><br><span class="line">  &#123; generated:</span><br><span class="line">   &#123; files:</span><br><span class="line">      [ &#123; dest: &apos;build/script/technode.js&apos;,</span><br><span class="line">          src: [ &apos;.tmp/concat/script/technode.js&apos; ] &#125; ] &#125; &#125;</span><br><span class="line"></span><br><span class="line">  cssmin:</span><br><span class="line">  &#123; generated:</span><br><span class="line">   &#123; files:</span><br><span class="line">      [ &#123; dest: &apos;build/css/technode.css&apos;,</span><br><span class="line">          src: [ &apos;.tmp/concat/css/technode.css&apos; ] &#125; ] &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>它为我们生成了本来需要手动编写的其他task的配置，接下来，安装其他几个需要的grunt task，继续修改Gruntfile.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">module.exports = function (grunt) &#123;</span><br><span class="line">  grunt.initConfig(&#123;</span><br><span class="line">    copy: &#123;</span><br><span class="line">      main: &#123;</span><br><span class="line">        files: [</span><br><span class="line">          &#123;expand: true, cwd: &apos;static/components/bootstrap/dist/fonts/&apos;, src: [&apos;**&apos;], dest: &apos;build/fonts&apos;&#125;,</span><br><span class="line">          &#123;&apos;build/index.html&apos;: &apos;static/index.html&apos;&#125;,</span><br><span class="line">          &#123;&apos;build/favicon.ico&apos;: &apos;static/favicon.ico&apos;&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    useminPrepare: &#123;</span><br><span class="line">      html: &apos;static/index.html&apos;,</span><br><span class="line">      options: &#123;</span><br><span class="line">        dest: &apos;build&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-usemin&apos;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-contrib-copy&apos;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-contrib-concat&apos;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-contrib-uglify&apos;)</span><br><span class="line">  grunt.loadNpmTasks(&apos;grunt-contrib-cssmin&apos;)</span><br><span class="line"></span><br><span class="line">  grunt.registerTask(&apos;default&apos;, [</span><br><span class="line">    &apos;copy&apos;,</span><br><span class="line">    &apos;useminPrepare&apos;,</span><br><span class="line">    &apos;concat&apos;,</span><br><span class="line">    &apos;uglify&apos;,</span><br><span class="line">    &apos;cssmin&apos;</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安装好新的依赖，再运行grunt试试看。首先concat根据useminPrepare生成的配置，将css和js分别合并到.tmp/concat/css/technode.css和.tmp/concat/script/technode.js中；然后uglify和cssmin分别将这两个文件压缩成了build/css/technode.css和build/script/technode.js，我们的css文件和js文件就打包压缩好了。</p>
<p>除此之外我们还需要把pages中的html内联到index.html中。在Angular中，我们既可以将模板文件单独放在不同的html文件中，也可以像下面这样，内联在html中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/ng-template&quot; id=&quot;/pages/login.html&quot;&gt;</span><br><span class="line">&lt;form class=&quot;form-inline form-login&quot; ng-submit=&quot;login()&quot;&gt;</span><br><span class="line">  &lt;div class=&quot;form-group&quot;&gt;</span><br><span class="line">    &lt;label class=&quot;sr-only&quot;&gt;Gmail&lt;/label&gt;</span><br><span class="line">    &lt;input type=&quot;email&quot; required class=&quot;form-control&quot; ng-model=&quot;email&quot; placeholder=&quot;Gmail账号&quot; /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary btn-enter&quot;&gt;进入&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><code>grunt-inline-angular-templates</code>就可以实现这样的需求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">inline_angular_templates: &#123;</span><br><span class="line">  dist: &#123;</span><br><span class="line">      options: &#123;</span><br><span class="line">          base: &apos;static/&apos;,</span><br><span class="line">          prefix: &apos;/&apos;</span><br><span class="line">      &#125;,</span><br><span class="line">      files: &#123;</span><br><span class="line">          &apos;build/index.html&apos;: [&apos;static/pages/*.html&apos;]</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用grunt-rev，为静态文件加上唯一标识，使用grunt-contrib-clean在每次打包开始时，清除.tmp和build里的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rev: &#123;</span><br><span class="line">  options: &#123;</span><br><span class="line">    encoding: &apos;utf8&apos;,</span><br><span class="line">    algorithm: &apos;md5&apos;,</span><br><span class="line">    length: 8</span><br><span class="line">  &#125;,</span><br><span class="line">  assets: &#123;</span><br><span class="line">    files: [&#123;</span><br><span class="line">      src: [</span><br><span class="line">        &apos;build/**/*.&#123;jpg,jpeg,gif,png,js,css,eot,svg,ttf,woff&#125;&apos;</span><br><span class="line">      ]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">clean: &#123;</span><br><span class="line">  main:[&apos;.tmp&apos;, &apos;build&apos;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，使用grunt-usemin提供的task usemin，将html中标记的合并区块已经css中的字体引用使用build目录中对应的压缩做了唯一标记的文件名替换掉：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">grunt.registerTask(&apos;default&apos;, [</span><br><span class="line">  &apos;clean&apos;,</span><br><span class="line">  &apos;copy&apos;,</span><br><span class="line">  &apos;useminPrepare&apos;,</span><br><span class="line">  &apos;concat&apos;,</span><br><span class="line">  &apos;uglify&apos;,</span><br><span class="line">  &apos;cssmin&apos;,</span><br><span class="line">  &apos;rev&apos;,</span><br><span class="line">  &apos;usemin&apos;,</span><br><span class="line">  &apos;inline_angular_templates&apos;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>于是我们整个构建的过程结束了，所有文件都按照我们想要的方式处理好了。</p>
<p>我们再来回顾一下打包的过程，开始那么多的js，首先被concat到了tmp/concat/technode.js中，然后aglify压缩到build/script/tecnhode.js中，接着rev根据文件内容为其生成了唯一的标示<code>7add9650.technode.js</code>，最后，usemin再把build/index.html中的js区块换成了<code>&lt;script src=&quot;/script/7add9650.technode.js&quot;&gt;&lt;/script&gt;</code>。这就是我们采用的整个打包压缩过程。同理css也是如此。</p>
<h3 id="发布TechNode"><a href="#发布TechNode" class="headerlink" title="发布TechNode"></a>发布TechNode</h3><p>发布之前我们还需要做一些准备工作，我们需要让生产环境中访问的是打包压缩过的静态文件，express为我们提供了一种区分开发环境和生产环境的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.configure(&apos;development&apos;, function () &#123;</span><br><span class="line">  app.set(&apos;staticPath&apos;, &apos;/static&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.configure(&apos;production&apos;, function () &#123;</span><br><span class="line">  app.set(&apos;staticPath&apos;, &apos;/build&apos;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(express.static(__dirname + app.get(&apos;staticPath&apos;)))</span><br></pre></td></tr></table></figure>
<p>如果我们运行<code>node app.js</code> express默认采用的是development环境，我们可以使用<code>NODE_ENV=production node app.js</code>来启用生产环境的配置，我们这里的做法很简单，将静态文件的路径指定到编译后的/build目录即可。</p>
<ul>
<li>修改config.js中的MongoDB配置，修改成对应的你在MongoHQ的数据库，例如：<code>mongodb://technode:technode@troup.mongohq.com:10046/technode</code></li>
<li>修改开发环境对应的Procfile文件，添加<code>web: NODE_ENV=production node app.js</code>，让TechNode以生产模式启动。</li>
</ul>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://sensitivemix.github.io/2017/06/11/websocket 聊天室/" title="websocket 聊天室" target="_blank" rel="external">https://sensitivemix.github.io/2017/06/11/websocket 聊天室/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/SensitiveMix" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/SensitiveMix" target="_blank"><span class="text-dark">Jack Sun</span><small class="ml-1x">Full Stack Developer</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom="">
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2017/06/11/那些年用过的 JQuery 之经典 QQ 表情插件/" title="那些年用过的 JQuery 之经典 QQ 表情插件"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2017/06/11/如何用 Node.js Cluster，监听异常的邮件提醒服务/" title="如何用 Node.js Cluster，监听异常的邮件提醒服务"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope="" itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/SensitiveMix" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <!-- <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div> -->
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>